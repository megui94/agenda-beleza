{% extends "base.html" %}
{% block title %}Redefinir Senha ‚Ä¢ {{ super() }}{% endblock %}

{% block content %}
<section class="page-hero">
  <div class="container">
    <h1>Redefinir Senha</h1>
    <p>Escolha uma nova senha segura para a sua conta.</p>
  </div>
</section>

<section class="section container" style="max-width:520px;">
  <form class="form card form-book" method="POST" action="{{ url_for('reset_token', token=token) }}">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert {{ 'alert-error' if category == 'error' else 'alert-success' }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="form-row" style="position:relative;">
      <label for="password">Nova Senha</label>
      <input id="password" name="password" type="password" required oninput="verificarForcaSenha()">
      <button type="button" class="show-password" aria-label="Mostrar senha" onclick="toggleSenha('password')">üëÅÔ∏è</button>
      <div class="password-strength-bar"><div id="password-strength"></div></div>
      <small id="password-hint" class="password-hint">
        A senha deve ter pelo menos 8 caracteres, incluindo 1 letra mai√∫scula, 1 min√∫scula e 1 n√∫mero.
      </small>
    </div>

    <div class="form-row" style="position:relative;">
      <label for="confirm_password">Confirmar Senha</label>
      <input id="confirm_password" name="confirm_password" type="password" required>
      <button type="button" class="show-password" aria-label="Mostrar senha" onclick="toggleSenha('confirm_password')">üëÅÔ∏è</button>
    </div>

    <button class="btn btn-primary" type="submit">Atualizar Senha</button>

    <p class="register-prompt">
      <a href="{{ url_for('login') }}">Voltar ao login</a>
    </p>
  </form>
</section>

<style>
.alert{padding:12px 15px;border-radius:8px;margin-bottom:15px;font-size:.95rem;text-align:center;font-weight:500;}
.alert-error{background:#ffe0e0;color:#c00000;border:1px solid #ffb3b3;}
.alert-success{background:#e0ffe4;color:#0a7a23;border:1px solid #b3ffca;}
.password-hint{display:block;margin-top:5px;font-size:.85rem;color:#777;}
.password-hint.invalid{color:#d11;}
.password-hint.valid{color:#090;}
.password-strength-bar{width:100%;height:6px;background:#eee;border-radius:4px;margin-top:5px;overflow:hidden;}
.password-strength-bar div{height:100%;width:0;border-radius:4px;transition:width .3s ease,background-color .3s ease;}
.show-password{position:absolute;right:10px;top:35px;background:none;border:none;cursor:pointer;font-size:1.2rem;}
.show-password:hover{opacity:.7;}
</style>

<script>
function toggleSenha(id){
  const campo=document.getElementById(id);
  campo.type=campo.type==='password'?'text':'password';
}
function verificarForcaSenha(){
  const senha=document.getElementById("password").value;
  const hint=document.getElementById("password-hint");
  const bar=document.getElementById("password-strength");
  let forca=0;
  if(senha.length>=8)forca++;
  if(/[A-Z]/.test(senha))forca++;
  if(/[a-z]/.test(senha))forca++;
  if(/[0-9]/.test(senha))forca++;
  if(/[^A-Za-z0-9]/.test(senha))forca++;
  bar.style.width=(forca/5*100)+"%";
  if(forca<=2){
    bar.style.backgroundColor="#e74c3c";
    hint.textContent="‚ùå Senha fraca. Use letras mai√∫sculas, min√∫sculas e n√∫meros.";
    hint.classList.add("invalid");
    hint.classList.remove("valid");
  } else if(forca<=4){
    bar.style.backgroundColor="#f39c12";
    hint.textContent="‚ö†Ô∏è Senha m√©dia. Pode ser mais segura.";
    hint.classList.add("valid");
    hint.classList.remove("invalid");
  } else {
    bar.style.backgroundColor="#27ae60";
    hint.textContent="‚úÖ Senha forte.";
    hint.classList.add("valid");
    hint.classList.remove("invalid");
  }
}
</script>
{% endblock %}
